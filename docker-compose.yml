

services:
  # ================= 基础设施 =================

  # 1. 统一 MySQL 数据库
  mysql:
    image: mysql:8.4
    container_name: mysql
    environment:
      MYSQL_ROOT_PASSWORD: root
    ports:
      - "3306:3306"
    volumes:
      - ./mysql-data:/var/lib/mysql
      # ⚠️ 确保 init-db 目录下有 00-init.sql (包含建库和建表语句)
      - ./init-db:/docker-entrypoint-initdb.d
    command:
      - --character-set-server=utf8mb4
      - --collation-server=utf8mb4_unicode_ci
      # MySQL 8.4 已移除 default-authentication-plugin 参数，这里删除了
    networks:
      - micro-net
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "root", "-proot"]
      interval: 10s
      timeout: 5s
      retries: 10

  # 2. Nacos (3.1.0)
  nacos:
    image: nacos/nacos-server:v3.1.0
    container_name: nacos
    environment:
      - MODE=standalone
      # 开启鉴权相关配置
      - NACOS_AUTH_ENABLE=true
      - NACOS_AUTH_TOKEN=VGhpc0lzTXlTdXBlckxvbmdBbmRBYnNvbHV0ZWx5U2VjdXJlU2VjcmV0S2V5Rm9yTmFjb3NBdXRoMTIzNDU=
      - NACOS_AUTH_IDENTITY_KEY=serverIdentity
      - NACOS_AUTH_IDENTITY_VALUE=serverIdentity
      - JAVA_OPT=-Xms256m -Xmx256m
    ports:
      - "8848:8848" # API 端口
      - "9848:9848" # gRPC 端口
      - "8849:8080" # UI 控制台端口 (宿主机访问 http://localhost:8849/nacos)
    networks:
      - micro-net
    healthcheck:
      test: [ "CMD-SHELL", "curl -f http://localhost:8080/ || exit 1" ]
      interval: 15s
      timeout: 10s
      retries: 10
      start_period: 120s
    restart: always

  # ================= 微服务 =================

  # 3. 用户服务
  user-service:
    build: ./user-service
    container_name: user-service
    environment:
      - SERVER_PORT=8081
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848
      - SPRING_CLOUD_NACOS_USERNAME=nacos
      - SPRING_CLOUD_NACOS_PASSWORD=nacos  # 对应 SQL 中初始化的密码
      - DB_URL=jdbc:mysql://mysql:3306/user_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - DB_USERNAME=root
      - DB_PASSWORD=root
      - JWT_SECRET=ThisIsMySuperLongAndExtremelySecureSecretKeyForHS512AlgorithmAtLeast64Chars
      - JWT_EXPIRATION=86400000
    ports:
      - "8081:8081"
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_healthy
    networks:
      - micro-net
    restart: on-failure

  # 4. 商品服务
  product-service:
    build: ./product-service
    container_name: product-service
    environment:
      - SERVER_PORT=8082
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848
      - SPRING_CLOUD_NACOS_USERNAME=nacos
      - SPRING_CLOUD_NACOS_PASSWORD=nacos
      - DB_URL=jdbc:mysql://mysql:3306/product_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - DB_USERNAME=root
      - DB_PASSWORD=root
    ports:
      - "8082:8082"
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_healthy
      inventory-service:
        condition: service_started
    networks:
      - micro-net
    restart: on-failure

  # 5. 库存服务
  inventory-service:
    build: ./inventory-service
    container_name: inventory-service
    environment:
      - SERVER_PORT=8083
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848
      - SPRING_CLOUD_NACOS_USERNAME=nacos
      - SPRING_CLOUD_NACOS_PASSWORD=nacos
      - DB_URL=jdbc:mysql://mysql:3306/inventory_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - DB_USERNAME=root
      - DB_PASSWORD=root

    ports:
      - "8083:8083"
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_healthy
    networks:
      - micro-net
    restart: on-failure

  # 6. 订单服务
  order-service:
    build: ./order-service
    container_name: order-service
    environment:
      - SERVER_PORT=8084
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848
      - SPRING_CLOUD_NACOS_USERNAME=nacos
      - SPRING_CLOUD_NACOS_PASSWORD=nacos
      - DB_URL=jdbc:mysql://mysql:3306/order_db?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      - DB_USERNAME=root
      - DB_PASSWORD=root
    ports:
      - "8084:8084"
    depends_on:
      nacos:
        condition: service_healthy
      mysql:
        condition: service_healthy
      user-service:
        condition: service_started
      product-service:
        condition: service_started
      inventory-service:
        condition: service_started
    networks:
      - micro-net
    restart: on-failure

  # 7. API 网关
  gateway-service:
    build: ./gateway-service
    container_name: gateway-service
    environment:
      - SERVER_PORT=8080
      - SPRING_PROFILES_ACTIVE=dev
      - SPRING_CLOUD_NACOS_DISCOVERY_SERVER_ADDR=nacos:8848
      - SPRING_CLOUD_NACOS_CONFIG_SERVER_ADDR=nacos:8848
      - SPRING_CLOUD_NACOS_USERNAME=nacos
      - SPRING_CLOUD_NACOS_PASSWORD=nacos
      - JWT_SECRET=ThisIsMySuperLongAndExtremelySecureSecretKeyForHS512AlgorithmAtLeast64Chars
    ports:
      - "8090:8080" # 映射宿主机 8090
    depends_on:
      nacos:
        condition: service_healthy
      user-service:
        condition: service_started
      product-service:
        condition: service_started
      order-service:
        condition: service_started
      inventory-service:
        condition: service_started
    networks:
      - micro-net
    restart: on-failure

networks:
  micro-net:
    driver: bridge